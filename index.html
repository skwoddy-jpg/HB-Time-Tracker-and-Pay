import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged, 
  signInWithCustomToken,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  updateProfile,
  linkWithCredential,
  EmailAuthProvider
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  onSnapshot, 
  updateDoc 
} from 'firebase/firestore';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'hb-clock-in-pro';

const App = () => {
  const [user, setUser] = useState(null);
  const [shifts, setShifts] = useState([]);
  const [cfg, setCfg] = useState({ 
    rate: "12.00", 
    s: new Date().toISOString().split('T')[0], 
    e: new Date().toISOString().split('T')[0], 
    theme: 'dark', 
    pName: '' 
  });
  const [activeSession, setActiveSession] = useState(null);
  const [display, setDisplay] = useState("00:00:00");
  const [breakDisplay, setBreakDisplay] = useState("00:00:00");
  const [modalMode, setModalMode] = useState(null); // 'help' | 'account' | null
  const [syncStatus, setSyncStatus] = useState('connecting');
  
  // Auth Form State
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [authError, setAuthError] = useState('');
  const [isAuthLoading, setIsAuthLoading] = useState(false);

  // --- 1. Authentication & Listener ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else if (!auth.currentUser) {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth failed", err);
        setSyncStatus('error');
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) setSyncStatus('synced');
    });
    return () => unsubscribe();
  }, []);

  // --- 2. Real-time Data Sync (Cloud -> App) ---
  useEffect(() => {
    if (!user) return;

    const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'userData', 'main');
    const unsub = onSnapshot(userDocRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        if (data.shifts) setShifts(data.shifts);
        if (data.config) setCfg(prev => ({ ...prev, ...data.config }));
        if (data.activeSession) setActiveSession(data.activeSession);
        setSyncStatus('synced');
      } else {
        // Initialize cloud storage for new users
        setDoc(userDocRef, { shifts: [], config: cfg, activeSession: null }, { merge: true });
      }
    }, (err) => {
      console.error(err);
      setSyncStatus('error');
    });

    return () => unsub();
  }, [user]);

  // --- 3. Timer Engine ---
  useEffect(() => {
    let interval;
    if (activeSession) {
      interval = setInterval(() => {
        const now = new Date().getTime();
        if (activeSession.isPaused) {
          const bDiff = now - activeSession.pauseStart;
          setBreakDisplay(formatTime(bDiff));
          const totalWorkSoFar = activeSession.pauseStart - activeSession.startTime - activeSession.pausedMs;
          setDisplay(formatTime(totalWorkSoFar));
        } else {
          const wDiff = now - activeSession.startTime - activeSession.pausedMs;
          setDisplay(formatTime(wDiff));
        }
      }, 1000);
    } else {
      setDisplay("00:00:00");
    }
    return () => clearInterval(interval);
  }, [activeSession]);

  // --- Cloud Operations ---
  const saveToCloud = async (updates) => {
    if (!user) return;
    setSyncStatus('syncing');
    try {
      const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'userData', 'main');
      await updateDoc(userDocRef, updates);
      setSyncStatus('synced');
    } catch (err) {
      setSyncStatus('error');
    }
  };

  const startClock = () => {
    const newSession = {
      startTime: new Date().getTime(),
      pausedMs: 0,
      isPaused: false,
      pauseStart: null
    };
    setActiveSession(newSession);
    saveToCloud({ activeSession: newSession });
  };

  const toggleBreak = () => {
    if (!activeSession) return;
    const now = new Date().getTime();
    const updated = { ...activeSession };
    if (!updated.isPaused) {
      updated.pauseStart = now;
      updated.isPaused = true;
    } else {
      updated.pausedMs += (now - updated.pauseStart);
      updated.isPaused = false;
      updated.pauseStart = null;
    }
    setActiveSession(updated);
    saveToCloud({ activeSession: updated });
  };

  const stopClock = () => {
    if (!window.confirm("Clock out?")) return;
    const now = new Date().getTime();
    let finalBreak = activeSession.pausedMs;
    if (activeSession.isPaused) finalBreak += (now - activeSession.pauseStart);

    const newShift = {
      st: new Date(activeSession.startTime).toISOString(),
      en: new Date(now).toISOString(),
      br: finalBreak
    };

    const newShifts = [newShift, ...shifts];
    setShifts(newShifts);
    setActiveSession(null);
    saveToCloud({ shifts: newShifts, activeSession: null });
  };

  const updateConfig = (field, value) => {
    const newCfg = { ...cfg, [field]: value };
    setCfg(newCfg);
    saveToCloud({ config: newCfg });
  };

  // --- Auth Handlers ---
  const handleLinkAccount = async (e) => {
    e.preventDefault();
    if (!email || !password) return;
    setIsAuthLoading(true);
    setAuthError('');
    try {
      const credential = EmailAuthProvider.credential(email, password);
      await linkWithCredential(auth.currentUser, credential);
      setModalMode(null);
      alert("Account successfully linked!");
    } catch (err) {
      setAuthError(err.message.includes('email-already-in-use') ? "This email is already linked to another account." : err.message);
    } finally {
      setIsAuthLoading(false);
    }
  };

  const handleLogin = async (e) => {
    e.preventDefault();
    setIsAuthLoading(true);
    setAuthError('');
    try {
      await signInWithEmailAndPassword(auth, email, password);
      setModalMode(null);
    } catch (err) {
      setAuthError("Login failed. Please check your credentials.");
    } finally {
      setIsAuthLoading(false);
    }
  };

  const formatTime = (ms) => {
    const s = Math.max(0, ms);
    const hh = Math.floor(s / 3600000).toString().padStart(2, '0');
    const mm = Math.floor((s % 3600000) / 60000).toString().padStart(2, '0');
    const ss = Math.floor((s % 60000) / 1000).toString().padStart(2, '0');
    return `${hh}:${mm}:${ss}`;
  };

  // Stats Logic
  const filteredShifts = shifts.filter(s => {
    const d = new Date(s.st);
    return d >= new Date(cfg.s) && d <= new Date(cfg.e + 'T23:59:59');
  });
  const totalHrs = filteredShifts.reduce((acc, s) => acc + (new Date(s.en) - new Date(s.st) - (s.br || 0)), 0) / 3600000;
  const totalPay = totalHrs * parseFloat(cfg.rate || 0);

  return (
    <div className={`min-h-screen w-full flex flex-col items-center p-4 transition-colors duration-500 ${cfg.theme === 'light' ? 'bg-slate-50 text-slate-800' : 'bg-[#0f172a] text-white'}`}
         style={{ background: cfg.theme === 'light' ? 'radial-gradient(at 0% 0%, #f1f5f9 0px, transparent 50%), radial-gradient(at 100% 100%, #e0e7ff 0px, transparent 50%), #f8fafc' : 'radial-gradient(at 0% 0%, #1e1b4b 0px, transparent 50%), radial-gradient(at 100% 100%, #4338ca 0px, transparent 50%), #0f172a' }}>
      
      {/* Top Nav */}
      <div className="w-full max-w-[500px] flex justify-between items-center py-4">
        <div className="flex flex-col">
            <h1 className="text-xl font-black tracking-tighter">HB PRO</h1>
            <div className="flex items-center gap-1.5 mt-0.5">
                <div className={`w-1.5 h-1.5 rounded-full ${syncStatus === 'synced' ? 'bg-emerald-500 shadow-[0_0_8px_#10b981]' : syncStatus === 'syncing' ? 'bg-amber-500 animate-pulse' : 'bg-rose-500'}`} />
                <span className="text-[9px] font-bold uppercase tracking-widest opacity-60">{syncStatus}</span>
            </div>
        </div>
        <div className="flex gap-2">
            <button onClick={() => setModalMode('account')} className="w-10 h-10 flex items-center justify-center bg-white/10 backdrop-blur-md border border-white/20 rounded-xl">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </button>
            <button onClick={() => setModalMode('help')} className="w-10 h-10 flex items-center justify-center bg-white/10 backdrop-blur-md border border-white/20 rounded-xl">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </button>
        </div>
      </div>

      <div className="w-full max-w-[500px] grid grid-cols-2 gap-4">
        
        {/* Timer Card */}
        <div className={`col-span-2 backdrop-blur-2xl border border-white/20 rounded-[30px] p-6 shadow-2xl relative transition-all duration-500 ${cfg.theme === 'light' ? 'bg-white/80' : 'bg-white/10'}`}>
            <div className={`inline-block px-3 py-1 rounded-full text-[10px] font-black tracking-widest text-white mb-4 ${activeSession ? (activeSession.isPaused ? 'bg-amber-500 shadow-[0_0_15px_#f59e0b]' : 'bg-emerald-500 shadow-[0_0_15px_#10b981]') : 'bg-white/20'}`}>
                {activeSession ? (activeSession.isPaused ? 'ON BREAK' : 'WORKING') : 'STANDBY'}
            </div>
            
            <p className="text-[10px] font-bold opacity-60 uppercase tracking-widest">Live Session</p>
            <h2 className="text-6xl font-black tracking-tighter my-2 tabular-nums">{display}</h2>

            {activeSession?.isPaused && (
                <div className="mt-4 pt-4 border-t border-white/10">
                    <p className="text-[10px] font-bold text-amber-500 uppercase tracking-widest">Break Time</p>
                    <p className="text-3xl font-bold text-amber-500 tabular-nums animate-pulse">{breakDisplay}</p>
                </div>
            )}

            <div className="grid grid-cols-2 gap-3 mt-6">
                {!activeSession ? (
                    <button onClick={startClock} className="col-span-2 py-4 bg-emerald-500 text-white font-bold rounded-2xl shadow-lg shadow-emerald-500/30 active:scale-95 transition-all">CLOCK IN</button>
                ) : (
                    <>
                        <button onClick={toggleBreak} className="py-4 bg-amber-500 text-white font-bold rounded-2xl shadow-lg shadow-amber-500/30 active:scale-95 transition-all uppercase text-xs">{activeSession.isPaused ? 'Resume' : 'Break'}</button>
                        <button onClick={stopClock} className="py-4 bg-rose-500 text-white font-bold rounded-2xl shadow-lg shadow-rose-500/30 active:scale-95 transition-all uppercase text-xs">Clock Out</button>
                    </>
                )}
            </div>
        </div>

        {/* Stats */}
        <div className="bg-white/10 backdrop-blur-md border border-white/20 rounded-[30px] p-5">
            <p className="text-[10px] font-bold opacity-60 uppercase tracking-widest">Earnings</p>
            <p className="text-2xl font-black text-emerald-500">£{totalPay.toFixed(2)}</p>
        </div>
        <div className="bg-white/10 backdrop-blur-md border border-white/20 rounded-[30px] p-5">
            <p className="text-[10px] font-bold opacity-60 uppercase tracking-widest">Hours</p>
            <p className="text-2xl font-black">{totalHrs.toFixed(2)}</p>
        </div>

        {/* Config */}
        <div className="col-span-2 bg-white/10 backdrop-blur-md border border-white/20 rounded-[30px] p-6">
            <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="text-[10px] font-bold opacity-60 uppercase tracking-widest">Rate (£)</label>
                    <input type="number" value={cfg.rate} onChange={(e) => updateConfig('rate', e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-center font-bold mt-1" />
                </div>
                <div>
                    <label className="text-[10px] font-bold opacity-60 uppercase tracking-widest">Period</label>
                    <input type="text" value={cfg.pName} onChange={(e) => updateConfig('pName', e.target.value)} placeholder="e.g. Project" className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-center font-bold mt-1" />
                </div>
                <div className="col-span-2 grid grid-cols-2 gap-4 mt-2">
                    <div>
                        <label className="text-[10px] font-bold opacity-60 uppercase tracking-widest">From</label>
                        <input type="date" value={cfg.s} onChange={(e) => updateConfig('s', e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-center font-bold mt-1 text-[11px]" />
                    </div>
                    <div>
                        <label className="text-[10px] font-bold opacity-60 uppercase tracking-widest">To</label>
                        <input type="date" value={cfg.e} onChange={(e) => updateConfig('e', e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-center font-bold mt-1 text-[11px]" />
                    </div>
                </div>
            </div>
            <button onClick={exportToEmail} className="w-full py-4 mt-4 bg-indigo-600 text-white font-bold rounded-2xl active:scale-95 transition-all uppercase text-xs tracking-widest shadow-lg shadow-indigo-600/20">Email Timesheet</button>
            <button onClick={() => updateConfig('theme', cfg.theme === 'light' ? 'dark' : 'light')} className="w-full mt-2 py-2 text-[10px] font-bold opacity-40 uppercase tracking-widest">Toggle {cfg.theme === 'light' ? 'Dark' : 'Light'} Mode</button>
        </div>

        {/* Log */}
        <div className="col-span-2 space-y-3">
            {filteredShifts.map((s, idx) => {
                const h = (new Date(s.en) - new Date(s.st) - (s.br || 0)) / 3600000;
                return (
                    <div key={idx} className="bg-white/5 border border-white/10 rounded-2xl p-4 flex justify-between items-center group hover:bg-white/10 transition-all">
                        <div>
                            <p className="font-bold">{new Date(s.st).toLocaleDateString('en-GB')}</p>
                            <p className="text-[10px] opacity-60 uppercase font-bold">{h.toFixed(2)} hrs • {Math.round((s.br || 0)/60000)}m break</p>
                        </div>
                        <p className="font-black text-emerald-500 text-lg">£{(h * parseFloat(cfg.rate || 0)).toFixed(2)}</p>
                    </div>
                );
            })}
        </div>

        <div className="col-span-2 text-center py-10 opacity-20 text-[10px] font-bold uppercase tracking-[4px]">
            HB Clock In Pro — v2.1 Sync
        </div>
      </div>

      {/* Account Modal */}
      {modalMode === 'account' && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/60 backdrop-blur-xl" onClick={() => setModalMode(null)}>
              <div className="bg-[#1e293b] border border-white/10 rounded-[40px] p-8 max-w-md w-full relative shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="absolute top-0 right-0 w-24 h-24 bg-indigo-500/10 blur-3xl -z-10" />
                <h3 className="text-xl font-black mb-2 flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    Cloud Account
                </h3>
                
                {user?.isAnonymous ? (
                    <div className="space-y-4">
                        <div className="p-4 bg-amber-500/10 border border-amber-500/20 rounded-2xl">
                            <p className="text-[10px] font-bold text-amber-500 uppercase mb-1">Warning: Unlinked Account</p>
                            <p className="text-xs opacity-70">You are using a temporary ID. Link an email to sync across devices.</p>
                        </div>
                        
                        <form onSubmit={handleLinkAccount} className="space-y-3">
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="Email Address" className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none" required />
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Strong Password" className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none" required />
                            {authError && <p className="text-[10px] text-rose-500 font-bold text-center">{authError}</p>}
                            <button type="submit" disabled={isAuthLoading} className="w-full py-3 bg-indigo-500 rounded-xl font-bold uppercase text-xs tracking-widest hover:opacity-90 disabled:opacity-50 transition-opacity">Link Email Now</button>
                        </form>
                        
                        <div className="pt-4 border-t border-white/5">
                            <p className="text-[10px] font-bold opacity-30 uppercase text-center mb-3">Or Login Existing</p>
                            <button onClick={handleLogin} className="w-full py-3 bg-white/5 border border-white/10 rounded-xl text-xs font-bold uppercase">Sign In Instead</button>
                        </div>
                    </div>
                ) : (
                    <div className="space-y-6">
                        <div className="p-5 bg-emerald-500/10 border border-emerald-500/20 rounded-2xl flex items-center gap-4">
                            <div className="w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center text-white">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            </div>
                            <div>
                                <p className="text-[10px] font-bold text-emerald-500 uppercase">Linked Account</p>
                                <p className="text-sm font-bold truncate max-w-[200px]">{user?.email}</p>
                            </div>
                        </div>
                        <button onClick={() => auth.signOut()} className="w-full py-3 bg-rose-500/10 border border-rose-500/20 text-rose-500 rounded-xl text-[10px] font-black uppercase tracking-widest">Sign Out</button>
                    </div>
                )}

                <div className="mt-8 pt-4 border-t border-white/5">
                    <p className="text-[10px] font-bold opacity-20 uppercase tracking-widest text-center">Your Device ID</p>
                    <p className="text-[8px] opacity-20 text-center font-mono select-all mt-1">{user?.uid}</p>
                </div>
              </div>
          </div>
      )}

      {/* Help Modal */}
      {modalMode === 'help' && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/60 backdrop-blur-xl" onClick={() => setModalMode(null)}>
              <div className="bg-[#1e293b] border border-white/10 rounded-[40px] p-8 max-w-md w-full relative" onClick={e => e.stopPropagation()}>
                <h3 className="text-xl font-black mb-4">HB Pro Help</h3>
                <div className="text-sm space-y-4 opacity-70 leading-relaxed max-h-[50vh] overflow-y-auto pr-2">
                    <section>
                        <p className="font-bold text-indigo-400 uppercase text-[10px] tracking-widest mb-1">Syncing</p>
                        <p>Use the Account tab to link your email. Once linked, logging in on another device will immediately merge and sync your shifts.</p>
                    </section>
                    <section>
                        <p className="font-bold text-indigo-400 uppercase text-[10px] tracking-widest mb-1">Privacy</p>
                        <p>All data is stored in your private user document. It is not shared or visible to anyone else.</p>
                    </section>
                    <section>
                        <p className="font-bold text-indigo-400 uppercase text-[10px] tracking-widest mb-1">Exports</p>
                        <p>Emails include a full breakdown of the current period based on your "From" and "To" settings.</p>
                    </section>
                </div>
                <button onClick={() => setModalMode(null)} className="w-full mt-8 py-4 bg-white/5 border border-white/10 rounded-2xl font-bold uppercase text-xs">Close Documentation</button>
              </div>
          </div>
      )}
    </div>
  );

  function exportToEmail() {
    let body = `Timesheet: ${cfg.pName}\nTotal Hours: ${totalHrs.toFixed(2)}\nTotal Pay: £${totalPay.toFixed(2)}\n\nBreakdown:\n`;
    filteredShifts.forEach(s => {
      const h = (new Date(s.en) - new Date(s.st) - (s.br || 0)) / 3600000;
      body += `${new Date(s.st).toLocaleDateString('en-GB')}: ${h.toFixed(2)} hrs (£${(h * cfg.rate).toFixed(2)})\n`;
    });
    window.location.href = `mailto:?subject=${encodeURIComponent('HB Pro Timesheet: ' + cfg.pName)}&body=${encodeURIComponent(body)}`;
  }
};

export default App;

