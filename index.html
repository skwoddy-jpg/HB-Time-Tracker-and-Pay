<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HB Clock In Pro</title>
    <!-- Load React, Babel, and Tailwind from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.cdnfonts.com/css/sf-pro-display');
        body { font-family: 'SF Pro Display', -apple-system, sans-serif; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-slow { animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, linkWithCredential, EmailAuthProvider, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hb-clock-in-pro';

        window.FB = { auth, db, appId, doc, setDoc, onSnapshot, updateDoc, linkWithCredential, EmailAuthProvider, signInWithEmailAndPassword, signOut, signInAnonymously };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [shifts, setShifts] = useState([]);
            const [cfg, setCfg] = useState({ rate: "12.00", s: new Date().toISOString().split('T')[0], e: new Date().toISOString().split('T')[0], theme: 'dark', pName: '' });
            const [activeSession, setActiveSession] = useState(null);
            const [display, setDisplay] = useState("00:00:00");
            const [breakDisplay, setBreakDisplay] = useState("00:00:00");
            const [modalMode, setModalMode] = useState(null);
            const [syncStatus, setSyncStatus] = useState('connecting');

            // Auth Fields
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');

            useEffect(() => {
                const unsubAuth = window.FB.onAuthStateChanged(window.FB.auth, (u) => {
                    if (!u) {
                        window.FB.signInAnonymously(window.FB.auth);
                    } else {
                        setUser(u);
                        setSyncStatus('synced');
                    }
                });
                return () => unsubAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                const userDocRef = window.FB.doc(window.FB.db, 'artifacts', window.FB.appId, 'users', user.uid, 'userData', 'main');
                const unsubData = window.FB.onSnapshot(userDocRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        if (data.shifts) setShifts(data.shifts);
                        if (data.config) setCfg(prev => ({ ...prev, ...data.config }));
                        if (data.activeSession) setActiveSession(data.activeSession);
                    } else {
                        window.FB.setDoc(userDocRef, { shifts: [], config: cfg, activeSession: null }, { merge: true });
                    }
                });
                return () => unsubData();
            }, [user]);

            useEffect(() => {
                let interval;
                if (activeSession) {
                    interval = setInterval(() => {
                        const now = new Date().getTime();
                        if (activeSession.isPaused) {
                            setBreakDisplay(formatTime(now - activeSession.pauseStart));
                            setDisplay(formatTime(activeSession.pauseStart - activeSession.startTime - activeSession.pausedMs));
                        } else {
                            setDisplay(formatTime(now - activeSession.startTime - activeSession.pausedMs));
                        }
                    }, 1000);
                } else {
                    setDisplay("00:00:00");
                }
                return () => clearInterval(interval);
            }, [activeSession]);

            const formatTime = (ms) => {
                const s = Math.max(0, ms);
                const hh = Math.floor(s / 3600000).toString().padStart(2, '0');
                const mm = Math.floor((s % 3600000) / 60000).toString().padStart(2, '0');
                const ss = Math.floor((s % 60000) / 1000).toString().padStart(2, '0');
                return `${hh}:${mm}:${ss}`;
            };

            const saveToCloud = async (updates) => {
                if (!user) return;
                setSyncStatus('syncing');
                const userDocRef = window.FB.doc(window.FB.db, 'artifacts', window.FB.appId, 'users', user.uid, 'userData', 'main');
                await window.FB.updateDoc(userDocRef, updates);
                setSyncStatus('synced');
            };

            const startClock = () => {
                const session = { startTime: new Date().getTime(), pausedMs: 0, isPaused: false, pauseStart: null };
                setActiveSession(session);
                saveToCloud({ activeSession: session });
            };

            const toggleBreak = () => {
                const now = new Date().getTime();
                const updated = { ...activeSession };
                if (!updated.isPaused) { updated.pauseStart = now; updated.isPaused = true; }
                else { updated.pausedMs += (now - updated.pauseStart); updated.isPaused = false; updated.pauseStart = null; }
                setActiveSession(updated);
                saveToCloud({ activeSession: updated });
            };

            const stopClock = () => {
                if (!confirm("End shift?")) return;
                const now = new Date().getTime();
                let b = activeSession.pausedMs + (activeSession.isPaused ? (now - activeSession.pauseStart) : 0);
                const newShifts = [{ st: new Date(activeSession.startTime).toISOString(), en: new Date(now).toISOString(), br: b }, ...shifts];
                setShifts(newShifts);
                setActiveSession(null);
                saveToCloud({ shifts: newShifts, activeSession: null });
            };

            const handleLink = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    const cred = window.FB.EmailAuthProvider.credential(email, password);
                    await window.FB.linkWithCredential(window.FB.auth.currentUser, cred);
                    setModalMode(null);
                    alert("Account linked successfully!");
                } catch (err) { setAuthError("Failed to link: " + err.message); }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    await window.FB.signInWithEmailAndPassword(window.FB.auth, email, password);
                    setModalMode(null);
                } catch (err) { setAuthError("Login failed."); }
            };

            const filtered = shifts.filter(s => {
                const d = new Date(s.st);
                return d >= new Date(cfg.s) && d <= new Date(cfg.e + 'T23:59:59');
            });
            const hrs = filtered.reduce((acc, s) => acc + (new Date(s.en) - new Date(s.st) - (s.br || 0)), 0) / 3600000;

            return (
                <div className={`min-h-screen flex flex-col items-center p-4 transition-all duration-500 ${cfg.theme === 'light' ? 'bg-slate-50 text-slate-900' : 'bg-[#0f172a] text-white'}`}
                     style={{ background: cfg.theme === 'light' ? 'radial-gradient(at 0% 0%, #f1f5f9 0px, transparent 50%), radial-gradient(at 100% 100%, #e0e7ff 0px, transparent 50%), #f8fafc' : 'radial-gradient(at 0% 0%, #1e1b4b 0px, transparent 50%), radial-gradient(at 100% 100%, #4338ca 0px, transparent 50%), #0f172a' }}>
                    
                    <div className="w-full max-w-[500px] flex justify-between items-center mb-4">
                        <div className="flex flex-col">
                            <h1 className="text-xl font-black tracking-tighter">HB PRO</h1>
                            <div className="flex items-center gap-1.5"><div className={`w-1.5 h-1.5 rounded-full ${syncStatus === 'synced' ? 'bg-emerald-500' : 'bg-amber-500 animate-pulse'}`} />
                            <span className="text-[9px] font-bold uppercase tracking-widest opacity-50">{syncStatus}</span></div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setModalMode('account')} className="w-10 h-10 flex items-center justify-center bg-white/10 backdrop-blur-md border border-white/20 rounded-xl">üë§</button>
                            <button onClick={() => setModalMode('help')} className="w-10 h-10 flex items-center justify-center bg-white/10 backdrop-blur-md border border-white/20 rounded-xl">‚ùì</button>
                        </div>
                    </div>

                    <div className="w-full max-w-[500px] grid grid-cols-2 gap-4">
                        <div className="col-span-2 bg-white/10 backdrop-blur-2xl border border-white/20 rounded-[30px] p-6 shadow-2xl">
                            <div className={`inline-block px-3 py-1 rounded-full text-[10px] font-black tracking-widest text-white mb-4 ${activeSession ? (activeSession.isPaused ? 'bg-amber-500' : 'bg-emerald-500') : 'bg-white/20'}`}>
                                {activeSession ? (activeSession.isPaused ? 'ON BREAK' : 'WORKING') : 'STANDBY'}
                            </div>
                            <h2 className="text-6xl font-black tracking-tighter tabular-nums mb-2">{display}</h2>
                            {activeSession?.isPaused && (
                                <div className="mt-2 text-amber-500 font-bold animate-pulse-slow">Break: {breakDisplay}</div>
                            )}
                            <div className="grid grid-cols-2 gap-3 mt-6">
                                {!activeSession ? (
                                    <button onClick={startClock} className="col-span-2 py-4 bg-emerald-500 text-white font-bold rounded-2xl">CLOCK IN</button>
                                ) : (
                                    <>
                                        <button onClick={toggleBreak} className="py-4 bg-amber-500 text-white font-bold rounded-2xl">{activeSession.isPaused ? 'RESUME' : 'BREAK'}</button>
                                        <button onClick={stopClock} className="py-4 bg-rose-500 text-white font-bold rounded-2xl">OUT</button>
                                    </>
                                )}
                            </div>
                        </div>

                        <div className="bg-white/10 border border-white/20 rounded-[30px] p-5">
                            <p className="text-[10px] font-bold opacity-50 uppercase mb-1">Earnings</p>
                            <p className="text-2xl font-black text-emerald-500">¬£{(hrs * parseFloat(cfg.rate)).toFixed(2)}</p>
                        </div>
                        <div className="bg-white/10 border border-white/20 rounded-[30px] p-5">
                            <p className="text-[10px] font-bold opacity-50 uppercase mb-1">Hours</p>
                            <p className="text-2xl font-black">{hrs.toFixed(2)}</p>
                        </div>

                        <div className="col-span-2 bg-white/10 border border-white/20 rounded-[30px] p-6">
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-[10px] font-bold opacity-50 uppercase">Rate (¬£)</label>
                                <input type="number" value={cfg.rate} onChange={e => { const r = e.target.value; setCfg(c => ({...c, rate: r})); saveToCloud({config: {...cfg, rate: r}}); }} className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-center font-bold mt-1" /></div>
                                <div><label className="text-[10px] font-bold opacity-50 uppercase">Period</label>
                                <input type="text" value={cfg.pName} onChange={e => { const n = e.target.value; setCfg(c => ({...c, pName: n})); saveToCloud({config: {...cfg, pName: n}}); }} className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-center font-bold mt-1" /></div>
                                <div className="col-span-2 grid grid-cols-2 gap-2 mt-2">
                                    <input type="date" value={cfg.s} onChange={e => { const v = e.target.value; setCfg(c => ({...c, s: v})); saveToCloud({config: {...cfg, s: v}}); }} className="bg-white/5 border border-white/10 rounded-xl p-3 text-center text-[11px] font-bold" />
                                    <input type="date" value={cfg.e} onChange={e => { const v = e.target.value; setCfg(c => ({...c, e: v})); saveToCloud({config: {...cfg, e: v}}); }} className="bg-white/5 border border-white/10 rounded-xl p-3 text-center text-[11px] font-bold" />
                                </div>
                            </div>
                            <button onClick={() => setCfg(c => { const n = {...c, theme: c.theme === 'light' ? 'dark' : 'light'}; saveToCloud({config: n}); return n; })} className="w-full mt-4 text-[10px] font-bold opacity-40 uppercase tracking-widest">Toggle Theme</button>
                        </div>

                        <div className="col-span-2 space-y-3">
                            {filtered.map((s, i) => (
                                <div key={i} className="bg-white/5 border border-white/10 rounded-2xl p-4 flex justify-between items-center">
                                    <div><p className="font-bold">{new Date(s.st).toLocaleDateString('en-GB')}</p><p className="text-[10px] opacity-50 font-bold uppercase">{((new Date(s.en)-new Date(s.st)-(s.br||0))/3600000).toFixed(2)} hrs</p></div>
                                    <p className="font-black text-emerald-500 text-lg">¬£{(((new Date(s.en)-new Date(s.st)-(s.br||0))/3600000) * parseFloat(cfg.rate)).toFixed(2)}</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    {modalMode === 'account' && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-xl" onClick={() => setModalMode(null)}>
                            <div className="bg-slate-900 border border-white/10 rounded-[40px] p-8 max-w-md w-full" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-black mb-4">Cloud Account</h3>
                                {user?.isAnonymous ? (
                                    <form onSubmit={handleLink} className="space-y-4">
                                        <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-xl p-3" required />
                                        <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-xl p-3" required />
                                        <button type="submit" className="w-full py-4 bg-indigo-600 rounded-2xl font-bold uppercase text-xs">Link Account</button>
                                        <button type="button" onClick={handleLogin} className="w-full py-2 opacity-50 text-[10px] font-bold uppercase">Sign In Instead</button>
                                    </form>
                                ) : (
                                    <div className="text-center">
                                        <p className="text-sm font-bold mb-4">{user?.email}</p>
                                        <button onClick={() => window.FB.signOut(window.FB.auth)} className="w-full py-4 bg-rose-500/20 text-rose-500 rounded-2xl font-bold uppercase text-xs">Sign Out</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>

