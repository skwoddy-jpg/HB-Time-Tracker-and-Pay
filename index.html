<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HB Clock in</title>
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --danger: #ef4444; --success: #059669; --warning: #f59e0b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 550px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .main-title { font-size: 2.2rem; font-weight: 900; color: var(--primary); text-align: center; margin: 0; text-transform: uppercase; }
        .timer-display { font-size: 3rem; font-weight: bold; text-align: center; margin: 15px 0; font-family: monospace; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button { padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; }
        .btn-start { background: var(--success); grid-column: span 2; }
        .btn-break { background: var(--warning); }
        .btn-stop { background: var(--danger); }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; background: #eff6ff; padding: 10px; border-radius: 8px; }
        .full-width { grid-column: span 2; }
        label { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; color: #1e40af; }
        input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 0.9rem; }
        .summary-banner { background: var(--primary); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center; }
        .entry-row { border-bottom: 1px solid #eee; padding: 12px 0; font-size: 0.85rem; }
        .edit-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 8px; }
        .edit-grid div { display: flex; flex-direction: column; }
        .edit-grid input { padding: 4px; font-size: 0.8rem; text-align: center; }
        .log-header { font-weight: bold; display: flex; justify-content: space-between; align-items: center; padding-bottom: 5px; border-bottom: 2px solid var(--bg); }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1 class="main-title">HB Clock in</h1>
        <div class="settings-grid">
            <div class="full-width"><label>Hourly Rate (£)</label><input type="number" id="globalRate" value="12.00" step="0.01" onchange="saveConfig()"></div>
            <div><label>Period Start</label><input type="date" id="periodStart" onchange="saveConfig()"></div>
            <div><label>Period End</label><input type="date" id="periodEnd" onchange="saveConfig()"></div>
        </div>
        <div class="timer-display" id="display">00:00:00</div>
        <div class="controls">
            <button id="startBtn" class="btn-start" onclick="startClock()">Clock In</button>
            <button id="breakBtn" class="btn-break" onclick="toggleBreak()" style="display:none;">Break</button>
            <button id="stopBtn" class="btn-stop" onclick="stopClock()" style="display:none;">Clock Out</button>
        </div>
    </div>

    <div class="summary-banner">
        <div style="font-size: 0.8rem; opacity: 0.9;">Current Period Total</div>
        <div class="summary-val" id="periodTotalPay" style="font-size:1.8rem; font-weight:bold;">£0.00</div>
        <div id="periodTotalStats" style="font-size: 0.9rem;">0.00 hrs | 0.00 break</div>
    </div>

    <div class="card">
        <div class="log-header"><span>Shift History</span><button onclick="exportData()" style="background:none; color:var(--primary); font-size:0.7rem; padding:0;">Backup Data</button></div>
        <div id="historyList"></div>
    </div>
</div>

<script>
    let startTime, timerInterval, elapsedPausedTime = 0, isPaused = false, pauseStart;
    let allShifts = JSON.parse(localStorage.getItem('hb_shifts_v3')) || [];
    let config = JSON.parse(localStorage.getItem('hb_config_v3')) || { rate: "12.00", start: new Date().toISOString().split('T')[0], end: new Date().toISOString().split('T')[0] };

    document.getElementById('globalRate').value = config.rate;
    document.getElementById('periodStart').value = config.start;
    document.getElementById('periodEnd').value = config.end;

    function saveConfig() {
        config.rate = document.getElementById('globalRate').value;
        config.start = document.getElementById('periodStart').value;
        config.end = document.getElementById('periodEnd').value;
        localStorage.setItem('hb_config_v3', JSON.stringify(config));
        updateView();
    }

    function updateView() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        let totalHrs = 0, totalBreakMs = 0;

        const filtered = allShifts.filter(s => {
            const d = new Date(s.start);
            return d >= new Date(config.start) && d <= new Date(config.end + 'T23:59:59');
        }).sort((a,b) => new Date(b.start) - new Date(a.start));

        filtered.forEach(shift => {
            const idx = allShifts.indexOf(shift);
            const durationMs = new Date(shift.end) - new Date(shift.start) - (shift.breakMs || 0);
            const hrs = Math.max(0, durationMs / 3600000);
            totalHrs += hrs;
            totalBreakMs += (shift.breakMs || 0);

            const row = document.createElement('div');
            row.className = 'entry-row';
            row.innerHTML = `
                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>${new Date(shift.start).toLocaleDateString('en-GB', {day:'2-digit', month:'short'})}</span>
                    <span style="color:var(--success)">£${(hrs * config.rate).toFixed(2)}</span>
                </div>
                <div class="edit-grid">
                    <div><label>Start</label><input type="time" value="${formatTimeForInput(shift.start)}" onchange="updateShift(${idx}, 'start', this.value)"></div>
                    <div><label>End</label><input type="time" value="${formatTimeForInput(shift.end)}" onchange="updateShift(${idx}, 'end', this.value)"></div>
                    <div><label>Break (min)</label><input type="number" value="${Math.round((shift.breakMs||0)/60000)}" onchange="updateShift(${idx}, 'break', this.value)"></div>
                </div>
                <div style="margin-top:5px; font-size:0.75rem; color:#666; display:flex; justify-content:space-between;">
                    <span>Net: ${hrs.toFixed(2)} hrs</span>
                    <button onclick="deleteShift(${idx})" style="color:var(--danger); background:none; border:none; padding:0;">Delete Shift</button>
                </div>
            `;
            list.appendChild(row);
        });

        document.getElementById('periodTotalPay').textContent = `£${(totalHrs * config.rate).toFixed(2)}`;
        document.getElementById('periodTotalStats').textContent = `${totalHrs.toFixed(2)} hrs worked | ${(totalBreakMs/3600000).toFixed(2)} hrs break`;
    }

    function formatTimeForInput(dateStr) {
        const d = new Date(dateStr);
        return d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
    }

    function updateShift(idx, field, val) {
        const shift = allShifts[idx];
        if (field === 'start' || field === 'end') {
            const baseDate = new Date(shift[field]);
            const [h, m] = val.split(':');
            baseDate.setHours(h, m);
            shift[field] = baseDate.toISOString();
        } else if (field === 'break') {
            shift.breakMs = parseInt(val) * 60000;
        }
        saveAndReload();
    }

    function startClock() {
        startTime = new Date();
        elapsedPausedTime = 0; isPaused = false;
        timerInterval = setInterval(updateDisplay, 1000);
        toggleUI(true);
    }

    function toggleBreak() {
        if (!isPaused) {
            pauseStart = new Date();
            isPaused = true;
            document.getElementById('breakBtn').textContent = "Resume";
        } else {
            elapsedPausedTime += (new Date() - pauseStart);
            isPaused = false;
            document.getElementById('breakBtn').textContent = "Break";
        }
    }

    function stopClock() {
        if(!confirm("Clock out?")) return;
        clearInterval(timerInterval);
        const end = new Date();
        let totalBreak = elapsedPausedTime;
        if(isPaused) totalBreak += (new Date() - pauseStart);
        
        allShifts.push({ start: startTime.toISOString(), end: end.toISOString(), breakMs: totalBreak });
        toggleUI(false);
        saveAndReload();
    }

    function updateDisplay() {
        let diff = new Date() - startTime;
        if (isPaused) diff = pauseStart - startTime;
        let h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
        document.getElementById('display').textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function toggleUI(running) {
        document.getElementById('startBtn').style.display = running ? 'none' : 'block';
        document.getElementById('breakBtn').style.display = running ? 'inline-block' : 'none';
        document.getElementById('stopBtn').style.display = running ? 'inline-block' : 'none';
        if(!running) document.getElementById('display').textContent = "00:00:00";
    }

    function deleteShift(idx) { if(confirm("Delete?")) { allShifts.splice(idx,1); saveAndReload(); } }
    function saveAndReload() { localStorage.setItem('hb_shifts_v3', JSON.stringify(allShifts)); updateView(); }
    function exportData() { alert("Your data is saved on this phone. To backup, copy this text: \n\n" + JSON.stringify(allShifts)); }

    updateView();
</script>
</body>
</html>
